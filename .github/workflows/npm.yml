name: Publish and Deploy

on:
  push:
    branches: [ master ]
  schedule:
    - cron: "*/15 * * * *"

concurrency:
  group: publish-and-deploy
  cancel-in-progress: false

jobs:
  check:
    name: Check whether build should run
    runs-on: ubuntu-slim
    permissions:
      actions: read
      contents: read
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
      matched_run_id: ${{ steps.gate.outputs.matched_run_id }}
      matched_time: ${{ steps.gate.outputs.matched_time }}
      blocked_by_run_id: ${{ steps.gate.outputs.blocked_by_run_id }}
      blocked_by_job: ${{ steps.gate.outputs.blocked_by_job }}
    steps:
      - name: Decide whether build should run
        id: gate
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          WORKFLOW_FILE: npm.yml
          TARGET_JOB_NAME: "Print decision info"
          MIN_SECONDS: "3600"
          CURRENT_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          now="$(date -u +%s)"

          # Default policy: "If there is no previous successful build, run the first build"
          should_run="true"
          matched_run_id=""
          matched_time=""
          found_any_success="false"

          # Condition B: no concurrently executing run (run.status=in_progress)
          blocked_by_run_id="$(gh api --paginate -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?status=in_progress&per_page=100" \
          | jq -r --arg CUR "$CURRENT_RUN_ID" '.workflow_runs[]|select((.id|tostring)!=$CUR)|.id' \
          | head -n1 || true)"
          blocked_by_job="run_status=in_progress"
          if [ -n "$blocked_by_run_id" ]; then
            should_run=false
            echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
            echo "blocked_by_run_id=$blocked_by_run_id" >> "$GITHUB_OUTPUT"
            echo "blocked_by_job=$blocked_by_job" >> "$GITHUB_OUTPUT"
            echo "matched_run_id=$matched_run_id" >> "$GITHUB_OUTPUT"
            echo "matched_time=$matched_time" >> "$GITHUB_OUTPUT"
            echo "found_any_success=$found_any_success" >> "$GITHUB_OUTPUT"
            exit 0
          fi




          if [ -n "$blocked_by_run_id" ]; then
            echo "Found another active run past prepare; skipping this run."
            should_run="false"

            echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
            echo "matched_run_id=$matched_run_id" >> "$GITHUB_OUTPUT"
            echo "matched_time=$matched_time" >> "$GITHUB_OUTPUT"
            echo "blocked_by_run_id=$blocked_by_run_id" >> "$GITHUB_OUTPUT"
            echo "blocked_by_job=$blocked_by_job" >> "$GITHUB_OUTPUT"
            echo "found_any_success=$found_any_success" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # --- end block ---

          if [ "${goto_output_and_exit:-0}" != 1 ]; then
            while read -r run_id; do
              [ "$run_id" = "$CURRENT_RUN_ID" ] && continue
              jobs="$(gh api -H "Accept: application/vnd.github+json" \
                "/repos/${REPO}/actions/runs/${run_id}/jobs?per_page=100")"
              read -r job_concl job_done < <(echo "$jobs" | jq -r --arg N "$TARGET_JOB_NAME" \
                '.jobs[]|select(.name==$N)|"\(.conclusion) \(.completed_at)"' | head -n1)
              [ "$job_concl" = "success" ] || continue
              found_any_success=true; matched_run_id="$run_id"; matched_time="$job_done"
              past="$(date -u -d "$job_done" +%s)"; elapsed=$((now-past))
              should_run=$([ "$elapsed" -lt "$MIN_SECONDS" ] && echo false || echo true); break
            done < <(gh api --paginate -H "Accept: application/vnd.github+json" \
                "/repos/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?status=completed&per_page=100" \
              | jq -r '.workflow_runs|sort_by(.created_at)|reverse|.[]|.id')
          fi


          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
          echo "matched_run_id=$matched_run_id" >> "$GITHUB_OUTPUT"
          echo "matched_time=$matched_time" >> "$GITHUB_OUTPUT"
          echo "blocked_by_run_id=$blocked_by_run_id" >> "$GITHUB_OUTPUT"
          echo "blocked_by_job=$blocked_by_job" >> "$GITHUB_OUTPUT"
          echo "found_any_success=$found_any_success" >> "$GITHUB_OUTPUT"

  prepare:
    name: Print decision info
    needs: check
    if: needs.check.outputs.should_run == 'true'
    runs-on: ubuntu-slim
    permissions:
      contents: none
    steps:
      - name: Print decision info
        run: |
          echo "Matched run id: ${{ needs.check.outputs.matched_run_id }}"
          echo "Matched time:   ${{ needs.check.outputs.matched_time }}"